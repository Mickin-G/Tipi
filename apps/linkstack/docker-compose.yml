version: '3.7'

services:
  linkstack:
    container_name: linkstack
    hostname: linkstack
    image: linkstackorg/linkstack:latest
    environment:
      - TZ=${TZ}
      - SERVER_ADMIN=${LINKSTACK_CUSTOM_EMAIL}
      - HTTP_SERVER_NAME=${APP_DOMAIN}
      - HTTPS_SERVER_NAME=${APP_DOMAIN}
      - LOG_LEVEL=info
      - PHP_MEMORY_LIMIT=256M
      - UPLOAD_MAX_FILESIZE=8M
      - DB_CONNECTION=sqlite
      - FORCE_HTTPS=true
    volumes:
      -  '${APP_DATA_DIR}/data/linkstack:/htdocs'
    ports:
      - 8184:80
      - '${APP_PORT}:443'
    restart: unless-stopped
    networks:
      - tipi_main_network
    labels:
      traefik.enable: ${APP_EXPOSED}
      traefik.http.routers.linkstack.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.linkstack.entrypoints: websecure
      traefik.http.routers.linkstack.service: linkstack
      traefik.http.routers.linkstack.tls.certresolver: myresolver
      traefik.http.routers.linkstack.tls: "true"
      traefik.http.services.linkstack.loadbalancer.server.port: 80
      traefik.http.routers.linkstack.middlewares: "linkstack-security-headers,linkstack-forwarded-headers"
      traefik.http.middlewares.linkstack-security-headers.headers.contentSecurityPolicy: "upgrade-insecure-requests"
      traefik.http.middlewares.linkstack-forwarded-headers.headers.customrequestheaders.X-Real-IP: "$remote_addr"
      traefik.http.middlewares.linkstack-forwarded-headers.headers.customrequestheaders.X-Forwarded-For: "$proxy_add_x_forwarded_for"
      traefik.http.middlewares.linkstack-forwarded-headers.headers.customrequestheaders.X-Forwarded-Proto: "https"
      traefik.http.middlewares.linkstack-forwarded-headers.headers.customrequestheaders.X-VerifiedViaNginx: "yes"
      traefik.http.middlewares.linkstack-forwarded-headers.headers.customrequestheaders.Upgrade: "$http_upgrade"
      traefik.http.middlewares.linkstack-forwarded-headers.headers.customrequestheaders.Connection: "upgrade"

